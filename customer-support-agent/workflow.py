"""
=============================================================================
커스텀 음성 워크플로우 클래스
=============================================================================

이 파일은 VoiceWorkflowBase를 상속받아 음성 입력 처리 워크플로우를 정의합니다.
음성 파이프라인에서 음성을 텍스트로 변환한 후, 이 워크플로우가 실행되어
에이전트를 통해 응답을 생성하고, 다시 텍스트로 반환합니다.

=============================================================================
워크플로우 흐름 (Workflow Flow)
=============================================================================

[VoicePipeline에서 호출]
    ↓
[CustomWorkflow.run(transcription)]
    ↓
[Runner.run_streamed() 실행]
    ├─ 현재 활성 에이전트 가져오기
    │   - st.session_state["agent"]
    │   - 초기: triage_agent
    │   - 이후: handoff로 전환된 에이전트
    │
    ├─ 에이전트 실행
    │   ├─ Input Guardrail 검사 (있는 경우)
    │   ├─ 에이전트 프롬프트 실행
    │   ├─ 도구(Tool) 호출 (필요시)
    │   ├─ Handoff 처리 (필요시)
    │   └─ 응답 생성
    │
    └─ 스트리밍 결과 반환
        ↓
[VoiceWorkflowHelper.stream_text_from()]
    - 에이전트 응답을 텍스트 청크로 변환
    - async generator로 스트리밍
    ↓
[yield chunk]
    - 각 텍스트 청크를 yield
    - VoicePipeline이 받아서 TTS로 변환
    ↓
[에이전트 상태 업데이트]
    - result.last_agent를 세션 상태에 저장
    - 다음 대화에서 이 에이전트가 계속 사용됨

=============================================================================
워크플로우의 역할
=============================================================================

1. 에이전트 실행 관리
   - Runner를 통해 에이전트 실행
   - 세션 및 컨텍스트 전달
   - 스트리밍 모드로 실행

2. 텍스트 스트리밍
   - 에이전트 응답을 청크 단위로 변환
   - VoicePipeline에 전달하여 TTS 처리

3. 상태 관리
   - 에이전트 전환 추적
   - 세션 상태 업데이트

=============================================================================
VoicePipeline과의 통합
=============================================================================

VoicePipeline의 전체 흐름:
1. STT: 음성 → 텍스트 변환
2. Workflow: 텍스트 → 에이전트 실행 → 텍스트 응답
3. TTS: 텍스트 → 음성 변환

이 워크플로우는 2단계를 담당합니다.
VoicePipeline이 이 워크플로우의 run() 메서드를 호출하여
에이전트를 실행하고 텍스트 응답을 받습니다.

=============================================================================
"""

# =============================================================================
# Import
# =============================================================================

# VoiceWorkflowBase: 음성 워크플로우의 기본 클래스
# VoiceWorkflowHelper: 음성 워크플로우를 위한 유틸리티 함수들
from agents.voice import VoiceWorkflowBase, VoiceWorkflowHelper

# Runner: 에이전트를 실행하는 클래스
# run_streamed: 스트리밍 방식으로 에이전트 실행
from agents import Runner

# Streamlit: 세션 상태에 접근하기 위해 필요
import streamlit as st


# =============================================================================
# CustomWorkflow 클래스
# =============================================================================

class CustomWorkflow(VoiceWorkflowBase):
    """
    음성 워크플로우를 구현하는 커스텀 클래스입니다.
    
    VoiceWorkflowBase를 상속받아 음성 파이프라인과 통합됩니다.
    이 클래스는 음성 입력이 텍스트로 변환된 후 호출되며,
    에이전트를 실행하여 응답을 생성합니다.
    
    주요 역할:
    - 에이전트 실행 및 스트리밍
    - 세션 상태 관리
    - 에이전트 전환 추적
    """
    
    def __init__(self, context):
        """
        워크플로우 초기화
        
        Args:
            context: UserAccountContext 객체
                    사용자 계정 정보를 포함하는 컨텍스트
        """
        self.context = context  # 사용자 계정 컨텍스트 저장

    async def run(self, transcription):
        """
        워크플로우 실행 메서드
        
        이 메서드는 VoicePipeline에서 호출됩니다.
        음성이 텍스트로 변환된 후(transcription), 이 메서드가 실행되어
        에이전트를 통해 응답을 생성하고 텍스트 청크로 스트리밍합니다.
        
        Args:
            transcription: str
                음성 입력이 텍스트로 변환된 결과
                예: "안녕하세요, 주문 상태를 확인하고 싶습니다"
        
        Yields:
            str: 에이전트 응답의 텍스트 청크들
                예: "안녕하세요", "주문", "상태를", "확인해드리겠습니다"
        
        동작 과정:
        1. Runner.run_streamed()로 에이전트 실행 시작
        2. VoiceWorkflowHelper.stream_text_from()으로 텍스트 청크 스트리밍
        3. 각 청크를 yield하여 VoicePipeline에 전달
        4. 마지막으로 활성화된 에이전트를 세션 상태에 저장
        """
        # =====================================================================
        # 에이전트 실행 (스트리밍 모드)
        # =====================================================================
        # Runner.run_streamed(): 에이전트를 스트리밍 방식으로 실행
        # 스트리밍: 응답을 전체가 완성되기 전에 청크 단위로 받아서 처리
        #           사용자가 더 빠르게 응답을 받을 수 있음
        result = Runner.run_streamed(
            st.session_state["agent"],  # 현재 활성화된 에이전트
                                        # 처음에는 triage_agent, 이후 전환될 수 있음
            transcription,  # 사용자의 음성 입력이 변환된 텍스트
            session=st.session_state["session"],  # 대화 기록 세션
            context=self.context,  # 사용자 계정 컨텍스트
        )

        # =====================================================================
        # 텍스트 청크 스트리밍
        # =====================================================================
        # VoiceWorkflowHelper.stream_text_from():
        # 에이전트 응답을 텍스트 청크 단위로 스트리밍
        # async generator를 반환하므로 async for로 순회
        async for chunk in VoiceWorkflowHelper.stream_text_from(result):
            # 각 텍스트 청크를 yield하여 VoicePipeline에 전달
            # VoicePipeline은 이 텍스트를 음성으로 변환합니다
            yield chunk

        # =====================================================================
        # 에이전트 상태 업데이트
        # =====================================================================
        # 에이전트가 handoff(전환)를 통해 다른 에이전트로 바뀌었을 수 있음
        # 예: triage_agent → billing_agent
        # 마지막으로 활성화된 에이전트를 세션 상태에 저장
        # 다음 대화에서 이 에이전트가 계속 사용됨
        st.session_state["agent"] = result.last_agent
